<script>
	const workers = new Map();
	let workerIdGen = 0;

	/**
	 * @param {string} code
	 * @param {MessagePort} port
	 *
	 * @returns {number} workerId
	 */
	function spawnWorker(code, port) {
		const worker = new Worker('./worker.js');
		worker.postMessage({ type: 'init', code }, [port]);

		const workerId = workerIdGen++;
		workers.set(workerId, worker);
		return workerId;
	}

	function killWorker(workerId) {
		const worker = workers.get(workerId);
		worker.terminate();

		workers.delete(workerId);
	}

	window.addEventListener(
		'message',
		(event) => {
			const caller = event.source;
			const message = event.data;
			if (message.type === 'spawnWorker') {
				const workerId = spawnWorker(message.code, event.ports[0]);
				caller.postMessage({ type: 'spawnWorker', workerId }, event.origin);
			} else if (message.type === 'killWorker') {
				killWorker(message.workerId);
			}
		},
		true
	);

	window.parent.postMessage({ type: 'sandboxReady' }, '*');
</script>
